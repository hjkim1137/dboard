<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Myboard</title>
    <link href="/main.css" rel="stylesheet" />
  </head>
  <body class="grey-bg">
    <%- include('nav.ejs')%>

    <!-- 왜인지 if-else가 안되어 if, if 사용 -->
      <div class="white-bg">
          <% for(let i=0; i<chatlist.length; i++) { %>
            <div class="list-box">
              <h4>
                <a href="/chat/detail?roomid=<%= chatlist[i]._id %>"><%=chatlist[i].chatName %></a>
                <div style="display: none" class="listchatId"><%=chatlist[i]._id %></div>
                <span
                class="deleteChat"
                data-id="<%=chatlist[i]._id %>"
                data-userid="<%=chatlist[i].user%>"
              >🗑️ 삭제</span>
              </h4>
              <% for(let j=0; j<lastChat.length; j++) { %>
                <% if (lastChat[j].roomId.equals(chatlist[i]._id)) { %>
                  <div class="contentBox">
                    <span><%= lastChat[j].chats %></span>
                    <span><%=lastChat[j].date%></span>
                  </div>
                <% } %>
              <% } %>
            </div>
          <% } %>
      
          <% if(chatlist.length == 0) { %>
            <div class="toChatlistPage">
              <a href="/list">시작한 채팅이 없습니다. 첫 채팅을 시작해보세요!</a>
            </div>
          <% } %>
      
          <script>
            let deleteBtns = document.querySelectorAll('.deleteChat');
    
            deleteBtns.forEach((btn, index) => {
              let chatIds = document.querySelectorAll('.listchatId');
              let chatIdValue = chatIds[index].innerText;
    
              btn.addEventListener('click', function (e) {
                if ('<%= loginUser%>' !== chatIdValue) {
                  btn.style.display = 'none';
                } else {
                  btn.style.display = 'block';
                }
    
                let roomidis = e.target.dataset.id;
    
                if (window.confirm('삭제하시겠습니까? 유저와 대화한 내용이 모두 삭제됩니다.')) {
                  fetch('/chat/list?roomId=' + roomidis, {
                    method: 'DELETE',
                  })
                    .then((res) => res.text())
                    .then((data) => {
                      e.target.parentElement.parentElement.style.display = 'none';
                    })
                    .catch((error) => {
                      console.error('오류 발생!!', error);
                      e.target.parentElement.parentElement.style.display = 'block';
                    });
                } else {
                  btn.style.display = 'inline';
                }
              });
            });
          </script>


      
      </div>
  </body>
</html>

