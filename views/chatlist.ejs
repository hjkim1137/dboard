<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Myboard</title>
    <script src="/main.js" ></script>
    <link href="/main.css" rel="stylesheet" />
  </head>
  <body class="grey-bg">
    <%- include('nav.ejs')%>

    <!-- ì™œì¸ì§€ if-elseê°€ ì•ˆë˜ì–´ if, if ì‚¬ìš© -->
      <div class="white-bg">
          <% for(let i=0; i<chatlist.length; i++) { %>
            <div class="list-box" id="list-box">
              <h4 class="title">
                <a href="/chat/detail?roomid=<%= chatlist[i]._id %>"><%=chatlist[i].chatName %></a>
                <div style="display: none" class="listchatId"><%=chatlist[i]._id %></div>
                <span
                class="deleteChat"
                data-id="<%=chatlist[i]._id %>"
                data-userid="<%=chatlist[i].user%>"
              >ğŸ—‘ï¸ ì‚­ì œ</span>
              </h4>
            
              <!-- true,false state ê°’ìœ¼ë¡œ ì²«ë²ˆì§¸ chatì´ ì—†ëŠ” ê²½ìš° ë°©ì§€í•˜ëŠ” ë²• -->
              <% let contentBoxExists = false %>

              <% for(let j=0; j<lastChat.length; j++) { %>
                <% if (lastChat[j].roomId.equals(chatlist[i]._id)) { %>

                  <% contentBoxExists = true %>
                  <div class="contentBox">
                    <p class="lastChat"><%= lastChat[j].chats %></p>
                    <p class="lastChat-date"><%= lastChat[j].date %></p>
                  </div>
                <% } %>
              <% } %>

              <!-- ì½˜í…ì¸  ë¶€ë¶„(ì²«ë²ˆì§¸ chatì´ ì—†ìœ¼ë©´ chatroomì´ ìƒì„±ëœ ì‹œê°„ì„ ë¶ˆëŸ¬ì˜´) -->
              <div class="noFirstChat">
                <p class="room-date" style="<%= contentBoxExists ? 'display: none' : '' %>"><%=chatlist[i].date %></p>
              </div>

            </div>
            <% } %>
           
          <% if(chatlist.length == 0) { %>
            <div class="toChatlistPage">
              <a href="/list">ì‹œì‘í•œ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</a>
            </div>
          <% } %>
      
          <!-- ì„œë²„ì—ì„œ ë Œë”ë§ í•˜ê³  ë‚œ ì´í›„ì— ì‹¤í–‰ë˜ëŠ” ë¶€ë¶„ -->
          <script>
          // ì±„íŒ… ë‚ ì§œìˆœ ì •ë ¬í•˜ê¸°
          let chatdates = document.querySelectorAll(".lastChat-date")

          let chatdatesArr =[]
          chatdates.forEach((date, idx) => {
            let chatdate = date.textContent;
            chatdatesArr.push({originalIndex: idx, date:chatdate});
          });

          //toSortedë¥¼ í™œìš©í•œ ì‚¬ë³¸ë°°ì—´
          const orderedDate = chatdatesArr.toSorted(function(a, b) {
          if (a.date < b.date) return 1;
          if (a.date > b.date) return -1;
          return 0;
          });

          // indexë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
          orderedDate.forEach((date, index) => {
            date.newIndex = index; // ìƒˆë¡œìš´ ì¸ë±ìŠ¤ ì¶”ê°€
          });

          // ìœ„ì˜ ì •ë ¬ ê¸°ì¤€ì— ë”°ë¼ì„œ list-box ì •ë ¬í•˜ê¸°
          let listboxes = document.querySelectorAll(".list-box");
            listboxes.forEach((box) => {
            // box.querySelector í•˜ë©´ íŠ¹ì • í•œ ê°œ ë°•ìŠ¤ì˜ ~
            let newIndex = orderedDate.find((date) => date.date === box.querySelector(".lastChat-date").textContent).newIndex;
            // (ì¤‘ìš”) order ì†ì„± ì ìš©í•˜ë ¤ë©´ listboxì˜ ë¶€ëª¨ìš”ì†Œ(white-bg)ì— flexë‚˜ grid ì ìš©ë˜ì•¼ í•¨
            box.style.order = newIndex
          });
          </script>

          <script>
          // ì‚­ì œ ê¸°ëŠ¥
            let deleteBtns = document.querySelectorAll('.deleteChat');
    
            deleteBtns.forEach((btn, index) => {
              let chatIds = document.querySelectorAll('.listchatId');
              let chatIdValue = chatIds[index].innerText;
    
              btn.addEventListener('click', function (e) {
                if ('<%= loginUser%>' !== chatIdValue) {
                  btn.style.display = 'none';
                } else {
                  btn.style.display = 'block';
                }
    
                let roomidis = e.target.dataset.id;
    
                if (window.confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìœ ì €ì™€ ëŒ€í™”í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                  fetch('/chat/list?roomId=' + roomidis, {
                    method: 'DELETE',
                  })
                    .then((res) => res.text())
                    .then((data) => {
                      e.target.closest('#list-box').style.display = 'none';
                    })
                    .catch((error) => {
                      console.error('ì˜¤ë¥˜ ë°œìƒ!!', error);
                      e.target.closest('#list-box').style.display = 'block';
                    });
                } else {
                  btn.style.display = 'inline';
                }
              });
            });
          </script>
      </div>
  </body>
</html>

